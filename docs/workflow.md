# 工作流程

工作流程可分为预处理、翻译、后处理三大块，其中

## 预处理阶段

对原始文件内容进行清洗与整理，将不符合规范的文件修改为符合 YAML 规范。

1. 添加缺失的引号
2. 将非标准的追踪数字号去除（参考 @./docs/about_localisation.md，`key:0 "text"` 中的数字 0 就是需要去除的追踪号）
3. 读取要加载的术语表文件，将所有术语合并，并提取本次任务所需的原始语言与目标语言两列，构造为 原始语言 => 目标语言 的 HashMap
4. 将文本头部的语言键名去除（例如 `l_english:`），并去除所有缩进。

## 翻译阶段

通过 API 访问大模型对传入的片段进行翻译。

1. 将待翻译的文件切片成适配大模型上下文尺寸的大小，每个切片保存其来源文件路径、片段顺序信息
2. 依次将切片进行翻译：
  1. 将切片中的键名按顺序替换成数字，并在另一变量中保存数字与原始键名的映射
  2. 搜索切片中涉及的术语，从术语表中提取相关的术语，转换成 CSV 格式嵌入到系统提示词中
  3. 将本切片的系统提示词、切片内容传递给大模型翻译
  4. 接收翻译结果
  5. 根据之前保存的数字与原始键名的映射，将切片中的键值对还原为键名: 内容的形式
  6. 对翻译结果进行检查，核对本地化文本中的特殊格式是否被破坏，如果存在破坏，则记录其文件路径、所在键名、原始内容、翻译后内容，以便后续人工修复。
3. 一个文件的所有切片翻译完成后，则将切片按顺序组合起来


## 后处理阶段

对翻译完成并组合完成的文件内容进行后处理。

1. 将翻译后内容统一增加一级缩进（两个空格）
2. 在文件头部增加目标语言的语言键名（假设目标语言为 simp_chinese，则添加 `l_simp_chinese:`
3. 根据翻译的目标语言，计算要保存的文件路径
4. 将处理完成的文件内容以 **UTF8 with BOM** 的字符编码保存在指定的文件路径中